# Environment Variables - Vercel

## Required Variables

### Database (Vercel Postgres)
```env
# Vercel Postgres Connection String
# Get from: Vercel Dashboard > Storage > Postgres
POSTGRES_URL=postgresql://user:password@ep-xxx.us-east-1.aws.neon.tech/neondb?sslmode=require

# Prisma Compatibility (set same as POSTGRES_URL)
DATABASE_URL=postgresql://user:password@ep-xxx.us-east-1.aws.neon.tech/neondb?sslmode=require
```

### Cache & Queue (Vercel KV)
```env
# Vercel KV REST API URL
# Get from: Vercel Dashboard > Storage > KV
KV_REST_API_URL=https://xxx.kv.vercel-storage.com

# Vercel KV REST API Token
# Get from: Vercel Dashboard > Storage > KV
KV_REST_API_TOKEN=your-kv-token-here

# Legacy Redis compatibility (optional)
REDIS_URL=redis://localhost:6379
```

### Object Storage (Vercel Blob)
```env
# Vercel Blob Read/Write Token
# Get from: Vercel Dashboard > Storage > Blob
BLOB_READ_WRITE_TOKEN=vercel_blob_xxx
```

### Configuration (Vercel Edge Config)
```env
# Vercel Edge Config ID
# Get from: Vercel Dashboard > Settings > Edge Config
EDGE_CONFIG_ID=your-edge-config-id
```

### Meta Graph API
```env
# Meta Application ID
# Get from: https://developers.facebook.com/apps
META_APP_ID=your-meta-app-id

# Meta Application Secret
# Get from: https://developers.facebook.com/apps
META_APP_SECRET=your-meta-app-secret

# Meta OAuth Redirect URI
# Local: http://localhost:3000/api/auth/callback
# Production: https://your-project.vercel.app/api/auth/callback
META_REDIRECT_URI=http://localhost:3000/api/auth/callback
```

### Authentication
```env
# JWT Secret (generate with: openssl rand -base64 32)
JWT_SECRET=your-jwt-secret-here-change-in-production
```

### Agent Configuration
```env
# Discovery Agent Interval (minutes)
DISCOVERY_INTERVAL_MINUTES=60

# Viral Score Threshold (0-100)
SCORING_THRESHOLD=70

# Maximum Retry Attempts
MAX_RETRY_ATTEMPTS=3

# Retry Backoff Delay (milliseconds)
RETRY_BACKOFF_MS=5000

# Rate Limit per Hour (per account)
RATE_LIMIT_PER_HOUR=200
```

### Cron Security
```env
# Cron Job Secret (generate with: openssl rand -base64 32)
# Used to secure cron job endpoints
CRON_SECRET=your-cron-secret-here
```

### Node.js Configuration
```env
# Environment (development | production)
NODE_ENV=development

# Port (local development only)
PORT=3000
```

---

## Local Development (.env.local)

```env
# Vercel Postgres (use production or local Docker)
POSTGRES_URL=postgresql://scheduler:password@localhost:5432/meta_scheduler

# Vercel KV (use production or local Redis)
KV_REST_API_URL=https://xxx.kv.vercel-storage.com
KV_REST_API_TOKEN=your-kv-token

# Vercel Blob (use production or local S3)
BLOB_READ_WRITE_TOKEN=vercel_blob_xxx

# Vercel Edge Config
EDGE_CONFIG_ID=your-edge-config-id

# Meta API (use same for all environments)
META_APP_ID=your-meta-app-id
META_APP_SECRET=your-meta-app-secret
META_REDIRECT_URI=http://localhost:3000/api/auth/callback

# JWT
JWT_SECRET=dev-jwt-secret

# Cron Security
CRON_SECRET=dev-cron-secret

# Settings
DISCOVERY_INTERVAL_MINUTES=60
SCORING_THRESHOLD=70
MAX_RETRY_ATTEMPTS=3
RETRY_BACKOFF_MS=5000
RATE_LIMIT_PER_HOUR=200

NODE_ENV=development
PORT=3000
```

---

## Production Environment Variables

Set these in Vercel Dashboard > Settings > Environment Variables:

### Required
- `POSTGRES_URL` - Vercel Postgres connection string
- `DATABASE_URL` - Same as POSTGRES_URL
- `KV_REST_API_URL` - Vercel KV URL
- `KV_REST_API_TOKEN` - Vercel KV token
- `BLOB_READ_WRITE_TOKEN` - Vercel Blob token
- `EDGE_CONFIG_ID` - Edge Config ID
- `META_APP_ID` - Meta Application ID
- `META_APP_SECRET` - Meta Application Secret
- `META_REDIRECT_URI` - Production redirect URI
- `JWT_SECRET` - Strong JWT secret
- `CRON_SECRET` - Strong cron secret

### Optional
- `REDIS_URL` - Legacy Redis compatibility
- `DISCOVERY_INTERVAL_MINUTES` - Default: 60
- `SCORING_THRESHOLD` - Default: 70
- `MAX_RETRY_ATTEMPTS` - Default: 3
- `RETRY_BACKOFF_MS` - Default: 5000
- `RATE_LIMIT_PER_HOUR` - Default: 200
- `NODE_ENV` - Set to "production"

---

## Vercel-Specific Environment Variables

These are automatically set by Vercel (don't set manually):

### Build Time
- `VERCEL_GIT_COMMIT_SHA` - Git commit SHA
- `VERCEL_GIT_COMMIT_MESSAGE` - Commit message
- `VERCEL_GIT_COMMIT_AUTHOR_NAME` - Author name
- `VERCEL_GIT_COMMIT_AUTHOR_LOGIN` - Author login
- `VERCEL_GIT_COMMIT_REF` - Git branch/tag

### Deployment
- `VERCEL_URL` - Deployment URL
- `VERCEL_ENV` - Environment (preview, production, development)
- `VERCEL_GIT_PROVIDER` - Git provider (github, gitlab, bitbucket)

### Application
- `VERCEL_REGION` - Deployment region (iad1, sfo1, etc.)

---

## Getting Vercel Credentials

### Vercel Postgres

1. Go to https://vercel.com/dashboard
2. Select your project
3. Go to Storage tab
4. Click on your Postgres database
5. Copy "Connection String" from ".env" section

### Vercel KV

1. Go to https://vercel.com/dashboard
2. Select your project
3. Go to Storage tab
4. Click on your KV database
5. Copy ".env" values:
   - `KV_REST_API_URL`
   - `KV_REST_API_TOKEN`

### Vercel Blob

1. Go to https://vercel.com/dashboard
2. Select your project
3. Go to Storage tab
4. Click on your Blob storage
5. Copy "BLOB_READ_WRITE_TOKEN"

### Vercel Edge Config

1. Go to https://vercel.com/dashboard
2. Select your project
3. Go to Settings > Edge Config
4. Copy "Edge Config ID"

---

## Security Best Practices

### 1. Generate Strong Secrets

```bash
# JWT Secret
openssl rand -base64 32

# Cron Secret
openssl rand -base64 32

# Meta App Secret (use Vercel's generated one or your own)
```

### 2. Use Environment-Specific Secrets

- Development: `.env.local` (never commit)
- Preview: Set in Vercel Dashboard (Preview environment)
- Production: Set in Vercel Dashboard (Production environment)

### 3. Rotate Secrets Regularly

- Change JWT secret every 90 days
- Rotate Meta app secret every 60 days
- Regenerate cron secret if compromised

### 4. Never Commit Secrets

Add `.env.local` to `.gitignore`:
```gitignore
# Environment variables
.env
.env.local
.env.*.local

# Vercel
.vercel
```

---

## Testing Environment Variables

### Test Database Connection

```bash
# Run Prisma Studio
npx prisma studio

# Or test connection
npx prisma db push
```

### Test KV Connection

```typescript
// Create test script: test-kv.ts
import { kv } from '@vercel/kv'

async function test() {
  await kv.set('test', 'hello world', { ex: 60 })
  const value = await kv.get('test')
  console.log('KV test:', value) // Should print "hello world"
}

test()
```

Run: `npx tsx test-kv.ts`

### Test Blob Connection

```typescript
// Create test script: test-blob.ts
import { put } from '@vercel/blob'

async function test() {
  const blob = await put('test.txt', Buffer.from('hello'), {
    access: 'public',
  })
  console.log('Blob test:', blob.url)
}

test()
```

Run: `npx tsx test-blob.ts`

### Test Edge Config

```typescript
// Create test script: test-edge-config.ts
import { get } from '@vercel/edge-config'

async function test() {
  const config = await get()
  console.log('Edge Config test:', config)
}

test()
```

Run: `npx tsx test-edge-config.ts`

---

## Troubleshooting

### Issue: Database connection fails

**Solution:**
1. Verify `POSTGRES_URL` format
2. Check database is active in Vercel Dashboard
3. Test connection with `npx prisma db push`
4. Check firewall allows Vercel IP ranges

### Issue: KV connection fails

**Solution:**
1. Verify `KV_REST_API_URL` and `KV_REST_API_TOKEN`
2. Check KV is active in Vercel Dashboard
3. Test with simple `kv.set()` and `kv.get()`
4. Check you're not exceeding KV limits

### Issue: Blob upload fails

**Solution:**
1. Verify `BLOB_READ_WRITE_TOKEN`
2. Check Blob storage is active in Vercel Dashboard
3. Check you haven't exceeded storage limit (100GB free)
4. Test with simple `put()` operation

### Issue: Edge Config not working

**Solution:**
1. Verify `EDGE_CONFIG_ID` is correct
2. Check Edge Config exists in Vercel Dashboard
3. Ensure configuration has been saved
4. Test with `await get()`

### Issue: Cron jobs failing

**Solution:**
1. Verify `CRON_SECRET` matches in cron route
2. Check cron routes exist: `app/api/cron/*/route.ts`
3. Test cron manually: `curl -H "Authorization: Bearer $CRON_SECRET" http://localhost:3000/api/cron/discovery`
4. Check Vercel cron logs in dashboard

---

## Example .env.local

```env
# Vercel Postgres
POSTGRES_URL=postgresql://postgres:password@ep-xxx.us-east-1.aws.neon.tech/neondb?sslmode=require
DATABASE_URL=postgresql://postgres:password@ep-xxx.us-east-1.aws.neon.tech/neondb?sslmode=require

# Vercel KV
KV_REST_API_URL=https://xxx.kv.vercel-storage.com
KV_REST_API_TOKEN=AXXXXXXXXXXXXXXXXXXXXX

# Vercel Blob
BLOB_READ_WRITE_TOKEN=vercel_blob_xxxxxxxxxxxxxxxxxxxxxxxxx

# Vercel Edge Config
EDGE_CONFIG_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Meta API
META_APP_ID=1234567890123456
META_APP_SECRET=abcdefghijklmnopqrstuvwxyz123456
META_REDIRECT_URI=http://localhost:3000/api/auth/callback

# JWT
JWT_SECRET=some-very-secure-random-jwt-secret-key-here

# Cron Security
CRON_SECRET=another-very-secure-random-cron-secret-key-here

# Agent Settings
DISCOVERY_INTERVAL_MINUTES=60
SCORING_THRESHOLD=70
MAX_RETRY_ATTEMPTS=3
RETRY_BACKOFF_MS=5000
RATE_LIMIT_PER_HOUR=200

# Node
NODE_ENV=development
PORT=3000
```

---

## Production Environment Checklist

Before deploying to production, ensure:

- [ ] All environment variables are set in Vercel Dashboard
- [ ] `POSTGRES_URL` is correct and database is active
- [ ] `KV_REST_API_URL` and `KV_REST_API_TOKEN` are correct
- [ ] `BLOB_READ_WRITE_TOKEN` is correct and Blob is active
- [ ] `EDGE_CONFIG_ID` is correct and config exists
- [ ] `META_REDIRECT_URI` points to production URL
- [ ] `JWT_SECRET` is strong and unique to production
- [ ] `CRON_SECRET` is strong and unique to production
- [ ] `NODE_ENV` is set to "production"
- [ ] Meta app has correct redirect URI for production
- [ ] Database migrations have been run
- [ ] Edge Config has production values
- [ ] All secrets are NOT committed to Git

---

## Resources

- [Vercel Environment Variables](https://vercel.com/docs/projects/environment-variables)
- [Vercel Postgres](https://vercel.com/docs/storage/vercel-postgres)
- [Vercel KV](https://vercel.com/docs/storage/vercel-kv)
- [Vercel Blob](https://vercel.com/docs/storage/vercel-blob)
- [Edge Config](https://vercel.com/docs/storage/edge-config)
- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)
- [Prisma Environment Variables](https://www.prisma.io/docs/concepts/environment-variables)
